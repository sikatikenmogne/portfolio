name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ===============================================
  # JOB 1: QUALITY GATES (all branches)
  # ===============================================
  quality:
    name: Quality Gates
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.pnpm-store
        key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-
          
    - name: Install dependencies
      run: |
        if [ -f pnpm-lock.yaml ]; then
          pnpm install --frozen-lockfile
        else
          pnpm install --no-frozen-lockfile
        fi
      
    - name: Lint code
      run: pnpm run lint
      
    - name: Build application
      run: pnpm run build

  # ===============================================
  # JOB 2: DEPLOY PREVIEW (develop only)
  # ===============================================
  deploy-preview:
    name: Deploy Preview
    runs-on: ubuntu-latest
    needs: quality
    if: github.ref == 'refs/heads/develop'
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Deploy to Vercel Preview
      uses: amondnet/vercel-action@v25
      id: vercel-preview
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./

  # ===============================================
  # JOB 3: DEPLOY PRODUCTION (main after merge)
  # ===============================================
  deploy-production:
    name: Deploy Production
    runs-on: ubuntu-latest
    needs: quality
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Deploy to Vercel Production
      uses: amondnet/vercel-action@v25
      id: vercel-production
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        vercel-args: '--prod'
        working-directory: ./
        
    - name: Production Deployment Notification
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: `Production Deployment - ${new Date().toISOString().split('T')[0]}`,
            body: `## Production Deployment Successful
            
            - **Live URL**: ${{ steps.vercel-production.outputs.preview-url }}
            - **Commit**: ${context.sha.substring(0, 7)}
            - **Deployed**: ${new Date().toISOString()}
            
            ### Verification Checklist
            - [ ] Homepage loads correctly
            - [ ] Navigation works
            - [ ] Contact form functional
            - [ ] Mobile responsive
            `,
            labels: ['deployment', 'production']
          });

  # ===============================================
  # JOB 4: PR PREVIEW COMMENT
  # ===============================================
  pr-preview-comment:
    name: PR Preview Comment
    runs-on: ubuntu-latest
    needs: quality
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Comment PR with Preview
      uses: actions/github-script@v6
      with:
        script: |
          const prNumber = context.issue.number;
          const commitSha = context.payload.pull_request.head.sha;
          
          github.rest.issues.createComment({
            issue_number: prNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## Pull Request Preview
            
            **Branch**: \`${context.payload.pull_request.head.ref}\`
            **Commit**: \`${commitSha.substring(0, 7)}\`
            
            ### Preview URLs
            **Develop Preview**: https://portfolio-git-develop-sikati-samuels-projects.vercel.app
            
            ### Review Checklist
            - [ ] Code reviewed and approved
            - [ ] Tests pass
            - [ ] Preview deployed successfully
            - [ ] No breaking changes
            - [ ] Ready for production
            
            *This preview will be automatically deployed to production when merged to main.*
            `
          });